# Use Node.js 20 Alpine for smaller image size
FROM node:20-alpine

# Set working directory
WORKDIR /app

ARG APP_URL
ENV APP_URL=$APP_URL
ARG MEDUSA_ADMIN_ONBOARDING_TYPE
ENV MEDUSA_ADMIN_ONBOARDING_TYPE=$MEDUSA_ADMIN_ONBOARDING_TYPE
ARG STORE_CORS
ENV STORE_CORS=$STORE_CORS
ARG ADMIN_CORS
ENV ADMIN_CORS=$ADMIN_CORS
ARG AUTH_CORS
ENV AUTH_CORS=$AUTH_CORS
ARG REDIS_URL
ENV REDIS_URL=$REDIS_URL
ARG JWT_SECRET
ENV JWT_SECRET=$JWT_SECRET
ARG COOKIE_SECRET
ENV COOKIE_SECRET=$COOKIE_SECRET
ARG DATABASE_URL
ENV DATABASE_URL=$DATABASE_URL
ARG MEDUSA_ADMIN_ONBOARDING_NEXTJS_DIRECTORY
ENV MEDUSA_ADMIN_ONBOARDING_NEXTJS_DIRECTORY=$MEDUSA_ADMIN_ONBOARDING_NEXTJS_DIRECTORY
ARG CONTENTFUL_MANAGEMENT_ACCESS_TOKEN
ENV CONTENTFUL_MANAGEMENT_ACCESS_TOKEN=$CONTENTFUL_MANAGEMENT_ACCESS_TOKEN
ARG CONTENTFUL_DELIVERY_TOKEN
ENV CONTENTFUL_DELIVERY_TOKEN=$CONTENTFUL_DELIVERY_TOKEN
ARG CONTENTFUL_SPACE_ID
ENV CONTENTFUL_SPACE_ID=$CONTENTFUL_SPACE_ID
ARG CONTENTFUL_ENVIRONMENT
ENV CONTENTFUL_ENVIRONMENT=$CONTENTFUL_ENVIRONMENT
ARG VNPAY_TMN_CODE
ENV VNPAY_TMN_CODE=$VNPAY_TMN_CODE
ARG VNPAY_HASH_SECRET
ENV VNPAY_HASH_SECRET=$VNPAY_HASH_SECRET
ARG VNPAY_HOST
ENV VNPAY_HOST=$VNPAY_HOST
ARG VNPAY_PAYMENT_URL
ENV VNPAY_PAYMENT_URL=$VNPAY_PAYMENT_URL
ARG VNPAY_RETURN_URL
ENV VNPAY_RETURN_URL=$VNPAY_RETURN_URL
ARG VNPAY_IPN_URL
ENV VNPAY_IPN_URL=$VNPAY_IPN_URL

RUN apk add --no-cache python3 make g++

# Copy package files
COPY package.json yarn.lock ./

# Install dependencies
RUN yarn install --frozen-lockfile

# Copy source code
COPY . .

# Build the application
RUN yarn build

# Create uploads directory
RUN mkdir -p uploads

# Expose port
EXPOSE 9000

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:9000/health || exit 1

# Start the application
CMD ["yarn", "start"] 